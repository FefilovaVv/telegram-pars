{% extends "base.html" %}

{% block title %}–≠–∫—Å–ø–æ—Ä—Ç - Telegram Parser{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        </h1>
        <p class="lead text-muted">
            –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ñ–∞–π–ª—ã, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å –ø–æ–º–æ—â—å—é –ò–ò (ChatGPT, Claude) –∏–ª–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ü–µ–ª–µ–π.
        </p>
    </div>
</div>

<!-- –¢–∏–ø—ã —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
<div class="row mb-4">
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="export-option h-100" data-export-type="overview">
            <i class="bi bi-speedometer2 fs-1 text-primary mb-3"></i>
            <h5>–û–±—â–∏–π –æ–±–∑–æ—Ä</h5>
            <p class="text-muted">
                –°–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º —á–∞—Ç–∞–º, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç–µ–º–∞–º. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ —Å –¥–∞–Ω–Ω—ã–º–∏.
            </p>
            <button class="btn btn-primary" data-export-type="overview">
                <i class="bi bi-download"></i> –°–æ–∑–¥–∞—Ç—å –æ–±–∑–æ—Ä
            </button>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="export-option h-100" data-export-type="topics">
            <i class="bi bi-tags fs-1 text-success mb-3"></i>
            <h5>–ê–Ω–∞–ª–∏–∑ —Ç–µ–º</h5>
            <p class="text-muted">
                –ß–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å —Å–ª–æ–≤ –∏ –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤. –ü–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã.
            </p>
            <button class="btn btn-success" data-export-type="topics">
                <i class="bi bi-download"></i> –°–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑ —Ç–µ–º
            </button>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="export-option h-100" data-export-type="package">
            <i class="bi bi-archive fs-1 text-warning mb-3"></i>
            <h5>–ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç</h5>
            <p class="text-muted">
                –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –Ω–∞–±–æ—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞, –≤–∫–ª—é—á–∞—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –ò–ò.
            </p>
            <button class="btn btn-warning" data-export-type="package">
                <i class="bi bi-download"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç
            </button>
        </div>
    </div>
</div>

<!-- –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-chat-left-text"></i> –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="chatSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç:</label>
                        <select class="form-select" id="chatSelect">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="exportDays" class="form-label">–ü–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π):</label>
                        <select class="form-select" id="exportDays">
                            <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                            <option value="30">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                            <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</option>
                            <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary" onclick="exportChat('chat')">
                                    <i class="bi bi-robot"></i> AI –∞–Ω–∞–ª–∏–∑
                                </button>
                                <button class="btn btn-outline-secondary" onclick="exportChat('conversation')">
                                    <i class="bi bi-chat-quote"></i> –î–∏–∞–ª–æ–≥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-file-earmark-check"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞
                </h5>
            </div>
            <div class="card-body" id="exportResults">
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-folder2-open fs-1"></i>
                    <p class="mt-2">–°–æ–∑–¥–∞–π—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å –ò–ò -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightbulb"></i> –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å –ò–ò
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">üìä –î–ª—è ChatGPT/Claude:</h6>
                        <ol class="small">
                            <li>–°–æ–∑–¥–∞–π—Ç–µ "–û–±—â–∏–π –æ–±–∑–æ—Ä" –∏–ª–∏ "–ü–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç"</li>
                            <li>–°–∫–∞—á–∞–π—Ç–µ JSON —Ñ–∞–π–ª –∏–∑ –ø–∞–ø–∫–∏ <code>parsed_data/ai_ready/</code></li>
                            <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —á–∞—Ç —Å –ò–ò</li>
                            <li>–°–ø—Ä–æ—Å–∏—Ç–µ: <em>"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –≤ Telegram"</em></li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-success">üí° –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ò–ò:</h6>
                        <ul class="small">
                            <li>"–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã —è –æ–±—Å—É–∂–¥–∞—é?"</li>
                            <li>"–ö–∞–∫ —Ä–∞–∑–ª–∏—á–∞–µ—Ç—Å—è –º–æ–π —Å—Ç–∏–ª—å –≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Ç–∞—Ö?"</li>
                            <li>"–í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è —è –Ω–∞–∏–±–æ–ª–µ–µ –∞–∫—Ç–∏–≤–µ–Ω?"</li>
                            <li>"–ö—Ç–æ —á–∞—â–µ –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥–∏?"</li>
                            <li>"–ö–∞–∫–∏–µ —ç–º–æ—Ü–∏–∏ –ø—Ä–µ–æ–±–ª–∞–¥–∞—é—Ç –≤ –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö?"</li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="bi bi-shield-check"></i>
                    <strong>–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:</strong> 
                    –ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –≤ –ò–ò –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. 
                    –î–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ò–ò –º–æ–¥–µ–ª–∏.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    loadChatsList();
});

async function loadChatsList() {
    try {
        // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —á–∞—Ç–æ–≤ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å API —ç–Ω–¥–ø–æ–∏–Ω—Ç)
        const chatSelect = document.getElementById('chatSelect');
        chatSelect.innerHTML = `
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç...</option>
            <option value="123">–õ–∏—á–Ω—ã–π —á–∞—Ç —Å –ü–µ—Ç–µ–π</option>
            <option value="456">–ì—Ä—É–ø–ø–∞ "–î—Ä—É–∑—å—è"</option>
            <option value="789">–ö–∞–Ω–∞–ª "–ù–æ–≤–æ—Å—Ç–∏"</option>
        `;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
        document.getElementById('chatSelect').innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    }
}

function exportChat(type) {
    const chatId = document.getElementById('chatSelect').value;
    const days = document.getElementById('exportDays').value;
    
    if (!chatId) {
        showNotification('error', '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }
    
    // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–∑ app.js
    performExport(type, chatId, days);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±—ã—Å—Ç—Ä–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
document.querySelectorAll('.export-option button').forEach(button => {
    button.addEventListener('click', function() {
        const exportType = this.dataset.exportType;
        performExport(exportType);
    });
});

// –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
document.querySelectorAll('.export-option').forEach(option => {
    option.addEventListener('click', function() {
        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        document.querySelectorAll('.export-option').forEach(o => o.classList.remove('selected'));
        // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é
        this.classList.add('selected');
    });
});

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é displayExportFiles –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.displayExportFiles = function(files) {
    const exportResults = document.getElementById('exportResults');
    
    let html = '<div class="row">';
    
    Object.entries(files).forEach(([type, path], index) => {
        const filename = path.split('/').pop();
        const icon = getFileIcon(type);
        const description = getFileDescription(type);
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border-success">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="bi ${icon} fs-2 text-success me-3"></i>
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">${type.charAt(0).toUpperCase() + type.slice(1)}</h6>
                                <p class="card-text small text-muted mb-1">${description}</p>
                                <code class="small">${filename}</code>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="copyPath('${path}')">
                                <i class="bi bi-clipboard"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—É—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    exportResults.innerHTML = html;
};

function getFileIcon(type) {
    const icons = {
        'overview': 'bi-speedometer2',
        'topics': 'bi-tags',
        'chat': 'bi-chat-left-text',
        'conversation': 'bi-chat-quote',
        'guide': 'bi-book'
    };
    return icons[type] || 'bi-file-earmark';
}

function getFileDescription(type) {
    const descriptions = {
        'overview': '–û–±—â–∏–π –æ–±–∑–æ—Ä –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
        'topics': '–ê–Ω–∞–ª–∏–∑ —Ç–µ–º –∏ —á–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç–∏ —Å–ª–æ–≤',
        'chat': '–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞',
        'conversation': '–ß–∏—Ç–∞–µ–º—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–∏–∞–ª–æ–≥–∞',
        'guide': '–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–ª—è –ò–ò'
    };
    return descriptions[type] || '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
}

function copyPath(path) {
    navigator.clipboard.writeText(path).then(() => {
        showNotification('success', '–ü—É—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
    }).catch(() => {
        showNotification('error', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—É—Ç—å');
    });
}

function showNotification(type, message) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ app.js
    if (window.showNotification) {
        window.showNotification(type, message);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}